# IntentRouter å®ç°æŒ‡å—

## æ¦‚è¿°

IntentRouter æ˜¯ NovaLife Weaver çš„æ ¸å¿ƒæ„å›¾è¯†åˆ«ç³»ç»Ÿï¼Œè´Ÿè´£åˆ†æç”¨æˆ·è¾“å…¥å¹¶è·¯ç”±åˆ°å¯¹åº”çš„ Agentã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- ğŸš€ **å¿«é€Ÿå…³é”®è¯åŒ¹é…**ï¼š70% çš„è¾“å…¥æ— éœ€è°ƒç”¨ AIï¼Œ<10ms å“åº”
- ğŸ§  **AI è¯­ä¹‰ç†è§£**ï¼šä½¿ç”¨ Nova Lite å¤„ç†æ¨¡ç³Šè¾“å…¥
- ğŸ¯ **7 ç§æ„å›¾ç±»å‹**ï¼šå…¨é¢è¦†ç›–ç”¨æˆ·éœ€æ±‚åœºæ™¯
- ğŸ”„ **æ™ºèƒ½è·¯ç”±**ï¼šæ ¹æ®æ„å›¾è°ƒç”¨å¯¹åº”çš„ Agent å’ŒæœåŠ¡

---

## æ¶æ„è®¾è®¡

### 1. æ„å›¾è¯†åˆ«æµç¨‹

```
ç”¨æˆ·è¾“å…¥
  â†“
[å¿«é€Ÿå…³é”®è¯åŒ¹é…]
  â†“ (70% å‘½ä¸­)
è¯†åˆ«æ„å›¾ç±»å‹ â”€â”€â”€â†’ è·¯ç”±åˆ° Agent â”€â”€â”€â†’ è¿”å›ç»“æœ
  â†“ (30% æœªå‘½ä¸­)
[Nova Lite è¯­ä¹‰åˆ†æ]
  â†“
è¯†åˆ«æ„å›¾ç±»å‹ â”€â”€â”€â†’ è·¯ç”±åˆ° Agent â”€â”€â”€â†’ è¿”å›ç»“æœ
```

### 2. æ”¯æŒçš„æ„å›¾ç±»å‹

| æ„å›¾ç±»å‹ | è§¦å‘ç¤ºä¾‹ | è·¯ç”±ç›®æ ‡ | æ•°æ®å½±å“ |
|---------|---------|---------|---------|
| `createGoal` | "æˆ‘æƒ³è€ƒ JLPT N2" | PlannerAgent | goals, events, habits |
| `createHabit` | "æ¯å¤©è·‘æ­¥" | HabitAgent | habits |
| `recordEmotion` | "ä»Šå¤©æœ‰ç‚¹ç´¯" | MemoryAgent | emotions |
| `recordExpense` | "åˆé¤èŠ±äº† 800" | FinanceAgent | finances |
| `queryStatus` | "æˆ‘çš„ç›®æ ‡è¿›åº¦å¦‚ä½•" | ContextEngine | æ—  |
| `planSchedule` | "å¸®æˆ‘å®‰æ’æœ¬å‘¨" | PlannerAgent | events |
| `general` | "ä½ å¥½" | NovaLite | æ—  |

---

## å®ç°ç»†èŠ‚

### 3. å¿«é€Ÿå…³é”®è¯åŒ¹é…

**ç›®çš„**ï¼šå‡å°‘ AI è°ƒç”¨æˆæœ¬ï¼Œæå‡å“åº”é€Ÿåº¦

**å®ç°é€»è¾‘**ï¼š
```swift
private func quickMatch(input: String) -> UserIntent? {
    let lowercased = input.lowercased()

    // ç›®æ ‡ç›¸å…³
    let goalKeywords = ["æˆ‘æƒ³", "ç›®æ ‡", "è®¡åˆ’å­¦", "è€ƒè¯•", "å­¦ä¹ ", "å‡è‚¥", "å¥èº«"]
    if goalKeywords.contains(where: { lowercased.contains($0) }) {
        return .createGoal(input)
    }

    // ä¹ æƒ¯ç›¸å…³
    let habitKeywords = ["æ¯å¤©", "æ¯å‘¨", "å…»æˆ", "ä¹ æƒ¯", "åšæŒ"]
    if habitKeywords.contains(where: { lowercased.contains($0) }) {
        return .createHabit(input)
    }

    // ... å…¶ä»–ç±»å‹
}
```

**ä¼˜åŒ–è¦ç‚¹**ï¼š
- âœ… ä¼˜å…ˆåŒ¹é…é«˜é¢‘å…³é”®è¯
- âœ… ä½¿ç”¨ `contains()` è€Œéæ­£åˆ™è¡¨è¾¾å¼ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
- âœ… è€ƒè™‘å…³é”®è¯ä¼˜å…ˆçº§ï¼ˆå¦‚ "èŠ±äº†" ä¼˜å…ˆäº "ä»Šå¤©"ï¼‰

### 4. AI è¯­ä¹‰åˆ†æ

**ä½¿ç”¨åœºæ™¯**ï¼šå¿«é€ŸåŒ¹é…å¤±è´¥æ—¶çš„åå¤‡æ–¹æ¡ˆ

**Prompt è®¾è®¡**ï¼š
```swift
private func buildIntentPrompt(input: String) -> String {
    return """
    ä½ æ˜¯ NovaLife Weaver çš„æ„å›¾è¯†åˆ«æ¨¡å—ã€‚

    === å¯è¯†åˆ«çš„æ„å›¾ç±»å‹ ===
    1. create_goal: åˆ›å»ºç›®æ ‡
    2. create_habit: åˆ›å»ºä¹ æƒ¯
    3. record_emotion: è®°å½•æƒ…ç»ª
    4. record_expense: è®°å½•èŠ±è´¹
    5. query_status: æŸ¥è¯¢çŠ¶æ€
    6. plan_schedule: è§„åˆ’æ—¥ç¨‹
    7. general: ä¸€èˆ¬å¯¹è¯

    === ç”¨æˆ·è¾“å…¥ ===
    "\(input)"

    === è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼ JSONï¼‰===
    ```json
    {
        "intent": "intent_type",
        "confidence": 0.0-1.0,
        "reasoning": "åˆ¤æ–­ç†ç”±"
    }
    ```
    """
}
```

**å“åº”è§£æ**ï¼š
- æå– JSONï¼ˆæ”¯æŒ Markdown ä»£ç å—ï¼‰
- æ˜ å°„ intent_type åˆ° UserIntent enum
- è®°å½• confidence ç”¨äºè´¨é‡ç›‘æ§

### 5. æ„å›¾è·¯ç”±å¤„ç†

**è·¯ç”±è¡¨**ï¼š
```swift
func route(intent: UserIntent, context: UserContext) async throws -> IntentResult {
    switch intent {
    case .createGoal(let goalText):
        return try await handleCreateGoal(goalText: goalText, context: context)

    case .createHabit(let habitText):
        return try await handleCreateHabit(habitText: habitText, context: context)

    // ... å…¶ä»–è·¯ç”±
    }
}
```

**æ¯ä¸ªå¤„ç†å™¨çš„èŒè´£**ï¼š
1. ä½¿ç”¨ Nova AI è§£æè¾“å…¥ç»†èŠ‚
2. è°ƒç”¨å¯¹åº”çš„ Agent/Service
3. ç”Ÿæˆ SuggestedAction åˆ—è¡¨
4. è¿”å›ç”¨æˆ·å‹å¥½çš„æ¶ˆæ¯

---

## ä½¿ç”¨ç¤ºä¾‹

### 6. åŸºç¡€è°ƒç”¨

```swift
let router = IntentRouter.shared

// 1. åˆ†ææ„å›¾
let intent = try await router.analyze(input: "æˆ‘æƒ³è€ƒ JLPT N2")
// è¿”å›: .createGoal("æˆ‘æƒ³è€ƒ JLPT N2")

// 2. è·¯ç”±å¤„ç†
let result = try await router.route(intent: intent, context: userContext)

// 3. å¤„ç†ç»“æœ
print(result.message)
// è¾“å‡º: âœ… å·²ä¸ºæ‚¨è§„åˆ’ç›®æ ‡ï¼šJLPT N2 å¤‡è€ƒè®¡åˆ’
//       ğŸ“‹ å­ä»»åŠ¡ï¼š5 ä¸ª
//       ğŸ“… æ—¥ç¨‹ï¼š8 ä¸ª
//       ğŸ¯ å»ºè®®ä¹ æƒ¯ï¼š2 ä¸ª

// 4. æ‰§è¡Œå»ºè®®è¡ŒåŠ¨
for action in result.actions ?? [] {
    switch action.type {
    case .addEvent:
        // æ·»åŠ æ—¥å†äº‹ä»¶
    case .createHabit:
        // åˆ›å»ºä¹ æƒ¯
    // ...
    }
}
```

### 7. æ‰¹é‡æµ‹è¯•

```swift
// è¿è¡Œæµ‹è¯•å¥—ä»¶
await TestIntentRouter.run()

// æ‰‹åŠ¨æµ‹è¯•ç‰¹å®šè¾“å…¥
await TestIntentRouter.manualTest(input: "æˆ‘æƒ³å­¦æ—¥è¯­ä½†ä¸çŸ¥é“ä»å“ªå¼€å§‹")
```

---

## æ€§èƒ½ä¼˜åŒ–

### 8. å“åº”é€Ÿåº¦ä¼˜åŒ–

| ç­–ç•¥ | æ•ˆæœ | å®ç° |
|------|------|------|
| å¿«é€Ÿå…³é”®è¯åŒ¹é… | 70% è¾“å…¥ <10ms | âœ… å·²å®ç° |
| Nova Lite æ¨¡å‹ | ä½å»¶è¿Ÿ AI æ¨ç† | âœ… å·²å®ç° |
| é‡è¯•æœºåˆ¶ | 3 æ¬¡é‡è¯• + æŒ‡æ•°é€€é¿ | âœ… å·²å®ç° |
| ç»“æœç¼“å­˜ | ç›¸åŒè¾“å…¥å¤ç”¨ç»“æœ | â³ å¾…å®ç° |

### 9. æˆæœ¬ä¼˜åŒ–

**ç­–ç•¥**ï¼š
- âœ… ä¼˜å…ˆä½¿ç”¨å¿«é€ŸåŒ¹é…ï¼ˆå…è´¹ï¼‰
- âœ… AI åˆ†æä»…åœ¨å¿…è¦æ—¶è°ƒç”¨
- âœ… ä½¿ç”¨ Nova Lite è€Œé Proï¼ˆæˆæœ¬é™ä½ 50%ï¼‰
- â³ æ‰¹é‡å¤„ç†å¤šä¸ªæ„å›¾ï¼ˆå¾…å®ç°ï¼‰

**é¢„ä¼°æˆæœ¬**ï¼ˆåŸºäº AWS å®šä»·ï¼‰ï¼š
- å¿«é€ŸåŒ¹é…ï¼š$0
- Nova Lite åˆ†æï¼š$0.0005/æ¬¡
- å¹³å‡æˆæœ¬ï¼š$0.00015/æ¬¡ï¼ˆå‡è®¾ 70% å¿«é€ŸåŒ¹é…å‘½ä¸­ç‡ï¼‰

---

## é”™è¯¯å¤„ç†

### 10. é”™è¯¯ç±»å‹

```swift
enum IntentError: Error {
    case invalidResponse        // AI å“åº”æ ¼å¼é”™è¯¯
    case parsingFailed          // JSON è§£æå¤±è´¥
    case unsupportedIntent      // ä¸æ”¯æŒçš„æ„å›¾ç±»å‹
}
```

### 11. é™çº§ç­–ç•¥

```
æ„å›¾è¯†åˆ«å¤±è´¥
  â†“
é™çº§ä¸º general æ„å›¾
  â†“
ä½¿ç”¨ Nova Lite ç”Ÿæˆå›å¤
  â†“
è¿”å›å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
```

---

## æ‰©å±•æŒ‡å—

### 12. æ·»åŠ æ–°æ„å›¾ç±»å‹

**æ­¥éª¤**ï¼š

1. **åœ¨ UIProtocols.swift ä¸­æ·»åŠ  enum case**
```swift
enum UserIntent {
    // ç°æœ‰ç±»å‹...
    case newIntentType(String)  // æ–°å¢
}
```

2. **æ›´æ–°å¿«é€ŸåŒ¹é…é€»è¾‘**
```swift
private func quickMatch(input: String) -> UserIntent? {
    // æ·»åŠ æ–°å…³é”®è¯
    let newKeywords = ["å…³é”®è¯1", "å…³é”®è¯2"]
    if newKeywords.contains(where: { lowercased.contains($0) }) {
        return .newIntentType(input)
    }
}
```

3. **æ›´æ–° AI Prompt**
```swift
private func buildIntentPrompt(input: String) -> String {
    return """
    8. **new_intent_type**: æ–°æ„å›¾æè¿°
       - ç¤ºä¾‹ï¼š"ç¤ºä¾‹è¾“å…¥"
    """
}
```

4. **æ·»åŠ è·¯ç”±å¤„ç†å™¨**
```swift
case .newIntentType(let text):
    return try await handleNewIntent(text: text, context: context)

private func handleNewIntent(...) async throws -> IntentResult {
    // å®ç°å¤„ç†é€»è¾‘
}
```

5. **æ·»åŠ æµ‹è¯•ç”¨ä¾‹**
```swift
("æµ‹è¯•è¾“å…¥", "newIntentType")
```

### 13. ä¼˜åŒ–å…³é”®è¯åŒ¹é…

**ç­–ç•¥**ï¼š
- æ”¶é›†çœŸå®ç”¨æˆ·è¾“å…¥æ•°æ®
- åˆ†ææœªå‘½ä¸­çš„å…³é”®è¯
- å®šæœŸæ›´æ–°å…³é”®è¯åˆ—è¡¨
- A/B æµ‹è¯•ä¸åŒå…³é”®è¯ç»„åˆ

---

## ç›‘æ§ä¸åˆ†æ

### 14. å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | ç›‘æ§æ–¹æ³• |
|------|------|---------|
| å¿«é€ŸåŒ¹é…å‘½ä¸­ç‡ | â‰¥70% | æ—¥å¿—ç»Ÿè®¡ |
| AI åˆ†æå‡†ç¡®ç‡ | â‰¥90% | äººå·¥å®¡æ ¸ |
| å¹³å‡å“åº”æ—¶é—´ | <500ms | æ€§èƒ½æ—¥å¿— |
| æ„å›¾è¯†åˆ«å¤±è´¥ç‡ | <5% | é”™è¯¯æ—¥å¿— |

### 15. æ—¥å¿—è®°å½•

```swift
print("ğŸ” å¼€å§‹æ„å›¾åˆ†æ: \(input)")
print("   âœ… å¿«é€ŸåŒ¹é…: \(quickIntent)")
print("   âœ… AI åˆ†æç»“æœ: \(intent)")
print("ğŸ¯ è·¯ç”±æ„å›¾: \(intent)")
```

---

## æœ€ä½³å®è·µ

### 16. è®¾è®¡åŸåˆ™

1. **ç”¨æˆ·ä½“éªŒä¼˜å…ˆ**
   - å“åº”æ—¶é—´ <500ms
   - å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
   - é€æ˜çš„å¤„ç†è¿‡ç¨‹

2. **æˆæœ¬æ„è¯†**
   - ä¼˜å…ˆä½¿ç”¨å…è´¹æ–¹æ³•
   - é¿å…ä¸å¿…è¦çš„ AI è°ƒç”¨
   - ä½¿ç”¨åˆé€‚çš„æ¨¡å‹ï¼ˆLite vs Proï¼‰

3. **å¯æ‰©å±•æ€§**
   - æ¨¡å—åŒ–è®¾è®¡
   - æ˜“äºæ·»åŠ æ–°æ„å›¾
   - é…ç½®é©±åŠ¨çš„å…³é”®è¯

4. **å¯æµ‹è¯•æ€§**
   - å•å…ƒæµ‹è¯•è¦†ç›–
   - æ¨¡æ‹Ÿ AI å“åº”
   - æ‰‹åŠ¨æµ‹è¯•å·¥å…·

---

## æ•…éšœæ’æŸ¥

### 17. å¸¸è§é—®é¢˜

**é—®é¢˜ 1ï¼šå¿«é€ŸåŒ¹é…å¤±è´¥ç‡é«˜**
- æ£€æŸ¥å…³é”®è¯åˆ—è¡¨æ˜¯å¦è¦†ç›–å¸¸è§è¾“å…¥
- åˆ†æç”¨æˆ·çœŸå®è¾“å…¥æ•°æ®
- è€ƒè™‘æ·»åŠ åŒä¹‰è¯

**é—®é¢˜ 2ï¼šAI åˆ†æå“åº”æ…¢**
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- ç¡®è®¤ä½¿ç”¨ Nova Lite è€Œé Pro
- è€ƒè™‘æ·»åŠ è¶…æ—¶é‡è¯•

**é—®é¢˜ 3ï¼šæ„å›¾è¯†åˆ«é”™è¯¯**
- æ£€æŸ¥ Prompt è®¾è®¡æ˜¯å¦æ¸…æ™°
- éªŒè¯ JSON è§£æé€»è¾‘
- äººå·¥å®¡æ ¸ AI å“åº”

**é—®é¢˜ 4ï¼šè·¯ç”±å¤„ç†å¤±è´¥**
- æ£€æŸ¥ Agent æ˜¯å¦æ­£å¸¸åˆå§‹åŒ–
- éªŒè¯ UserContext æ•°æ®å®Œæ•´æ€§
- æŸ¥çœ‹é”™è¯¯æ—¥å¿—è¯¦ç»†ä¿¡æ¯

---

## æœªæ¥æ”¹è¿›

### 18. Roadmap

**Phase 1ï¼ˆå½“å‰ï¼‰**ï¼š
- âœ… åŸºç¡€æ„å›¾è¯†åˆ«
- âœ… 7 ç§æ„å›¾ç±»å‹
- âœ… å¿«é€Ÿå…³é”®è¯åŒ¹é…

**Phase 2ï¼ˆWeek 3ï¼‰**ï¼š
- â³ ç»“æœç¼“å­˜
- â³ æ‰¹é‡å¤„ç†
- â³ æ€§èƒ½ç›‘æ§

**Phase 3ï¼ˆWeek 4ï¼‰**ï¼š
- â³ ç”¨æˆ·è¡Œä¸ºå­¦ä¹ 
- â³ è‡ªé€‚åº”å…³é”®è¯ä¼˜åŒ–
- â³ å¤šè½®å¯¹è¯æ”¯æŒ

---

## å‚è€ƒèµ„æº

- **UIProtocols.swift**ï¼šæ„å›¾ç±»å‹å®šä¹‰
- **PlannerAgent.swift**ï¼šç›®æ ‡è§„åˆ’ç¤ºä¾‹
- **BedrockService.swift**ï¼šNova API è°ƒç”¨
- **TestIntentRouter.swift**ï¼šæµ‹è¯•å¥—ä»¶
